name: ðŸš€ Deploy to Koyeb

on:
  push:
    branches: [main]
    paths:
      - 'Dockerfile.koyeb'
      - 'start-vllm.sh'
      - 'app/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docker build (redeploy only)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ vars.DOCKERHUB_USER }}/dragon-llm-inference
  KOYEB_APP_NAME: dragon-llm
  KOYEB_SERVICE_NAME: open-finance-inference

jobs:
  build-and-push:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_build != 'true'
    permissions:
      contents: read

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      sha-tag: ${{ steps.sha.outputs.tag }}

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_ACCESS_KEY }}

      - name: ðŸ·ï¸ Compute SHA tag
        id: sha
        run: |
          SHA_TAG=sha-${GITHUB_SHA::7}
          echo "tag=$SHA_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ SHA tag: $SHA_TAG"

      - name: ðŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=vllm-amd64,enable={{is_default_branch}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ§¹ Clean up disk space
        run: |
          docker system prune -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: ðŸ—ï¸ Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.koyeb
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy-koyeb:
    name: ðŸš€ Deploy to Koyeb
    needs: build-and-push
    runs-on: ubuntu-latest
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped')
    environment:
      name: production
      url: https://dragon-llm-dealexmachina-673cae4f.koyeb.app
    env:
      KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}

    steps:
      - name: ðŸ”§ Install Koyeb CLI
        uses: koyeb-community/koyeb-actions@v2
        with:
          api_token: ${{ secrets.KOYEB_API_TOKEN }}

      - name: ðŸš€ Deploy to Koyeb
        run: |
          APP_NAME="${{ env.KOYEB_APP_NAME }}"
          SVC_NAME="${{ env.KOYEB_SERVICE_NAME }}"
          
          if [ "${{ github.event.inputs.skip_build }}" = "true" ]; then
            IMAGE="${{ env.IMAGE_NAME }}:vllm-amd64"
          else
            IMAGE="${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.sha-tag }}"
          fi
          
          echo "ðŸ“¦ Deploying image: $IMAGE"
          echo "ðŸ“ App: $APP_NAME / Service: $SVC_NAME"
          
          koyeb services update "$APP_NAME/$SVC_NAME" --docker "$IMAGE"
          
          echo "âœ… Service update triggered!"

      - name: â³ Wait for deployment
        run: sleep 60

      - name: ðŸ¥ Health check
        run: |
          SERVICE_URL="https://dragon-llm-dealexmachina-673cae4f.koyeb.app"
          
          for i in {1..5}; do
            echo "ðŸ” Health check attempt $i/5..."
            response=$(curl -s -w "%{http_code}" -o /dev/null "$SERVICE_URL/health" --max-time 30 || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "âœ… Deployment is healthy!"
              exit 0
            fi
            echo "â³ Status: $response, retrying in 60s..."
            sleep 60
          done
          
          echo "âš ï¸ Health check did not pass, but deployment may still be starting up."

      - name: ðŸ“ Deployment Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Deployment Summary
          - **App**: \`${{ env.KOYEB_APP_NAME }}\`
          - **Service**: \`${{ env.KOYEB_SERVICE_NAME }}\`
          - **Instance**: GPU NVIDIA L40S
          - **Region**: Frankfurt
          - **URL**: https://dragon-llm-dealexmachina-673cae4f.koyeb.app
          EOF

  redeploy-only:
    name: ðŸ”„ Redeploy (no build)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.skip_build == 'true'
    environment:
      name: production
      url: https://dragon-llm-dealexmachina-673cae4f.koyeb.app
    env:
      KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}

    steps:
      - name: ðŸ”§ Install Koyeb CLI
        uses: koyeb-community/koyeb-actions@v2
        with:
          api_token: ${{ secrets.KOYEB_API_TOKEN }}

      - name: ðŸš€ Redeploy to Koyeb
        run: |
          IMAGE="${{ env.IMAGE_NAME }}:vllm-amd64"
          echo "ðŸ“¦ Redeploying with image: $IMAGE"
          
          koyeb services update "${{ env.KOYEB_APP_NAME }}/${{ env.KOYEB_SERVICE_NAME }}" \
            --docker "$IMAGE"
          
          echo "âœ… Redeployment triggered!"
          echo "ðŸ”— URL: https://dragon-llm-dealexmachina-673cae4f.koyeb.app"
